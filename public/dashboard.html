<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Dashboard ‚Äî Galer√≠a de Sue√±os</title>
	<link rel="icon" href="https://fav.farm/üì∏" />

	<!-- Fonts & Icons -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

	<!-- Firebase SDKs (compat) -->
	<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
	<script>
		window.FIREBASE_CONFIG = {
			apiKey: "AIzaSyBJKfRHcU9xkrPZg-lpYOBQWEzFTzCVSFc",
			authDomain: "fotografias-ensuenos-35972.firebaseapp.com",
			projectId: "fotografias-ensuenos-35972",
			messagingSenderId: "440755499521",
			appId: "1:440755499521:web:d9d41ed30ea0e1f3a44600",
			measurementId: "G-XLTZPGKZJB"
		};
		try {
			if (typeof firebase !== 'undefined' && window.FIREBASE_CONFIG) {
				if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
			}
		} catch (e) {
			console.warn('Firebase init failed', e);
		}
	</script>

	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="dashboard.css">
	<link rel="stylesheet" href="dashboard_premium.css">
</head>

<body class="dashboard-theme">
	<!-- Sidebar -->
	<aside class="sidebar" id="sidebar">
		<a href="/" class="sidebar-logo">
			<i class="fa-solid fa-camera-retro"></i>
			<span>Ensue√±os</span>
		</a>

		<nav class="side-nav">
			<a href="#" class="nav-link active" data-section="overview">
				<i class="fa-solid fa-house"></i>
				<span>Vista General</span>
			</a>
			<a href="#" class="nav-link" data-section="upload" id="nav-upload">
				<i class="fa-solid fa-cloud-arrow-up"></i>
				<span>Subir Fotos</span>
			</a>
			<a href="#" class="nav-link" data-section="gallery">
				<i class="fa-solid fa-images"></i>
				<span>Gestionar Galer√≠a</span>
			</a>
			<a href="#" class="nav-link" data-section="trash">
				<i class="fa-solid fa-trash-can"></i>
				<span>Papelera</span>
			</a>
		</nav>

		<div class="sidebar-footer">
			<a href="/" class="nav-link">
				<i class="fa-solid fa-arrow-left"></i>
				<span>Ir al Sitio</span>
			</a>
		</div>
	</aside>

	<!-- Main Content -->
	<main class="main-content">
		<!-- Dashboard Header -->
		<header class="dashboard-header">
			<div class="header-title">
				<h1 id="section-title">Vista General</h1>
				<p id="section-subtitle">Gestiona tu portafolio fotogr√°fico</p>
			</div>

			<div class="header-actions">
				<div class="theme-toggle" title="Cambiar Tema">
					<i class="fa-solid fa-moon"></i>
				</div>
				<button class="btn btn-primary" id="btn-quick-upload">
					<i class="fa-solid fa-plus"></i>
					<span>Nueva Foto</span>
				</button>
				<div class="mobile-toggle" id="mobile-toggle">
					<i class="fa-solid fa-bars"></i>
				</div>
			</div>
		</header>

		<!-- Stats Grid (Overview) -->
		<section id="section-overview" class="dashboard-section">
			<div class="dashboard-grid">
				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Total Fotos</span>
							<i class="fa-solid fa-image text-muted"></i>
						</div>
						<h2 id="stat-total-photos">0</h2>
						<p class="text-muted" style="font-size: 12px; margin-top: 8px;" id="stat-public-count">0
							P√∫blicas</p>
					</div>
				</div>
				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Categor√≠as</span>
							<i class="fa-solid fa-tags text-muted"></i>
						</div>
						<h2 id="stat-categories">0</h2>
						<p class="text-muted" style="font-size: 11px; margin-top: 8px;" id="stat-categories-list">--</p>
					</div>
				</div>
				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Estado Sistema</span>
							<i class="fa-solid fa-server text-muted"></i>
						</div>
						<div style="display: flex; align-items: center; gap: 8px;">
							<span class="dot dot-online"></span>
							<h2 style="font-size: 20px;">Firebase Live</h2>
						</div>
						<p class="text-muted" style="font-size: 12px; margin-top: 4px;">Latencia: <span
								id="db-latency">--</span>ms</p>
					</div>
				</div>
			</div>

			<div class="card" style="margin-top: 24px;">
				<div class="card-header">
					<span class="card-title">Acciones R√°pidas</span>
				</div>
				<div
					style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-top: 8px;">
					<button class="btn btn-primary" onclick="showSection('upload')">
						<i class="fa-solid fa-plus"></i> Subir Foto
					</button>
					<button class="btn btn-secondary" onclick="showSection('gallery')">
						<i class="fa-solid fa-grip"></i> Gestionar Todo
					</button>
					<button class="btn btn-secondary" id="btn-reindex-quick">
						<i class="fa-solid fa-arrow-down-9-1"></i> Corregir Orden
					</button>
					<a href="/" class="btn btn-secondary" target="_blank">
						<i class="fa-solid fa-eye"></i> Ver Web
					</a>
				</div>
			</div>

			<div class="dashboard-grid">
				<div class="col-8">
					<div class="card" style="height: 100%;">
						<div class="card-header">
							<span class="card-title"><i class="fa-solid fa-chart-line"></i> M√©tricas de
								Rendimiento</span>
						</div>
						<div
							style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 24px;">
							<div class="metric">
								<span class="text-muted" style="font-size: 13px;">Uso de Firestore</span>
								<div
									style="height: 6px; background: var(--bg-input); border-radius: 3px; margin: 8px 0;">
									<div id="firestore-bar"
										style="width: 5%; height: 100%; background: var(--accent); border-radius: 3px;">
									</div>
								</div>
								<span style="font-size: 11px;"><span id="firestore-usage">0</span> / 50k
									lecturas/d√≠a</span>
							</div>
							<div class="metric">
								<span class="text-muted" style="font-size: 13px;">Visitas hoy</span>
								<h3 style="margin-top: 4px;" id="stat-visits">42</h3>
							</div>
							<div class="metric">
								<span class="text-muted" style="font-size: 13px;">Categor√≠a Top</span>
								<h3 style="margin-top: 4px;" id="stat-top-cat">--</h3>
							</div>
							<div class="metric">
								<span class="text-muted" style="font-size: 13px;">√öltima subida</span>
								<h3 style="margin-top: 4px; font-size: 15px;" id="stat-last-upload">--</h3>
							</div>
						</div>
					</div>
				</div>

				<div class="col-4">
					<div class="card" style="height: 100%;">
						<div class="card-header">
							<span class="card-title"><i class="fa-solid fa-bolt"></i> Acciones R√°pidas</span>
						</div>
						<div style="display: flex; flex-direction: column; gap: 12px;">
							<button class="btn btn-secondary btn-block" id="btn-backup" style="text-align: left;">
								<i class="fa-solid fa-download"></i> Backup JSON
							</button>
							<button class="btn btn-secondary btn-block" id="btn-optimize-all" style="text-align: left;">
								<i class="fa-solid fa-wand-magic-sparkles"></i> Optimizar Galer√≠a
							</button>

						</div>
					</div>
				</div>
			</div>

			<!-- Full Width Reminders -->
			<div class="card" style="margin-top: 24px;">
				<div class="card-header">
					<span class="card-title"><i class="fa-solid fa-list-check"></i> Tareas de Mantenimiento</span>
				</div>
				<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; padding: 10px 0;">
					<div class="reminder-item"
						style="display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; border: 1px solid rgba(255,255,255,0.05);">
						<i class="fa-solid fa-trash-can" style="color:var(--accent); font-size: 1.2rem;"></i>
						<span style="font-size:13px;">Revisar papelera cada 7 d√≠as para vaciado manual.</span>
					</div>
					<div class="reminder-item"
						style="display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; border: 1px solid rgba(255,255,255,0.05);">
						<i class="fa-solid fa-tags" style="color:var(--accent); font-size: 1.2rem;"></i>
						<span style="font-size:13px;">Actualizar tags de "Bodas" para mejorar SEO.</span>
					</div>
					<div class="reminder-item"
						style="display:flex; align-items:center; gap:12px; background:rgba(255,255,255,0.03); padding:15px; border-radius:10px; border: 1px solid rgba(255,255,255,0.05);">
						<i class="fa-solid fa-gauge-high" style="color:var(--accent); font-size: 1.2rem;"></i>
						<span style="font-size:13px;">Verificar latencia de red en Firebase Console.</span>
					</div>
				</div>
			</div>

			<!-- Last KPIs: Side by Side Logs -->
			<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
				<div class="card">
					<div class="card-header">
						<span class="card-title"><i class="fa-solid fa-triangle-exclamation"
								style="color: var(--danger);"></i> Errores Cr√≠ticos</span>
					</div>
					<div id="error-log-list" class="error-log-list" style="max-height: 250px; overflow-y: auto;">
						<p class="text-muted" style="font-size: 13px;">No hay errores.</p>
					</div>
				</div>

				<div class="card">
					<div class="card-header">
						<span class="card-title"><i class="fa-solid fa-clock-rotate-left"></i> Historial de
							Actividad</span>
					</div>
					<div id="history-list" class="history-list" style="max-height: 250px; overflow-y: auto;">
						<p class="text-muted" style="font-size: 13px;">No hay acciones.</p>
					</div>
				</div>
			</div>
		</section>

		<!-- Upload Section -->
		<section id="section-upload" class="dashboard-section" style="display: none;">
			<div class="dashboard-grid">
				<div class="col-8">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Subir Im√°genes</span>
							<span id="pending-counter" class="status-badge status-private">0 Pendientes</span>
						</div>

						<div id="drop-area" class="upload-dropzone" tabindex="0">
							<i class="fa-solid fa-cloud-arrow-up"></i>
							<h3>Arrastra tus fotos aqu√≠</h3>
							<p>O haz clic para seleccionar archivos (JPG, PNG, WebP)</p>
							<input id="file-input" type="file" accept="image/*" multiple style="display:none">
						</div>

						<div id="selected-thumbs" class="thumbs-grid"
							style="display: none; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-top: 24px;">
							<!-- Thumbs will appear here -->
						</div>

						<div id="preview-list" class="preview-list" style="margin-top: 24px;">
							<!-- Previews with metadata will appear here -->
						</div>
					</div>
				</div>

				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Ajustes por Defecto</span>
						</div>
						<div class="form-group">
							<label>Visibilidad General</label>
							<select id="default-visibility" class="form-control">
								<option value="public">P√∫blica</option>
								<option value="private">Privada</option>
								<option value="hidden">Oculta</option>
							</select>
						</div>
						<div class="form-group">
							<label>Nomenclatura Autom√°tica</label>
							<input id="auto-naming" class="form-control" placeholder="ej: Boda_JuanyMaria_{n}">
						</div>
						<div class="form-group">
							<label>Origen Externo</label>
							<div style="display: flex; gap: 8px;">
								<input id="url-upload" class="form-control" placeholder="Pega URL de imagen">
								<button id="btn-url-add" class="btn btn-secondary"><i
										class="fa-solid fa-link"></i></button>
							</div>
						</div>
						<div class="form-group">
							<label>Acciones en Lote</label>
							<div style="display: flex; gap: 8px; flex-direction: column;">
								<button id="btn-save-all" class="btn btn-primary" disabled>
									<i class="fa-solid fa-floppy-disk"></i> Guardar Todo
								</button>
								<button id="btn-clear-all" class="btn btn-secondary">
									<i class="fa-solid fa-trash-can"></i> Limpiar Lista
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Gallery Section -->
		<section id="section-gallery" class="dashboard-section" style="display: none;">
			<div class="card">
				<div class="card-header">
					<span class="card-title">Gestionar Galer√≠a Publicada</span>
					<div class="header-actions">
						<button id="btn-save-order" class="btn btn-primary btn-sm">
							<i class="fa-solid fa-save"></i> Guardar Orden
						</button>
					</div>
				</div>

				<div class="gallery-controls">
					<div class="search-box">
						<i class="fa-solid fa-magnifying-glass"></i>
						<input type="text" id="gallery-search" class="form-control" placeholder="Buscar fotos...">
					</div>
					<select id="filter-category" class="form-control" style="width: auto; min-width: 150px;">
						<option value="all">Todas las categor√≠as</option>
					</select>
					<div class="btn-group">
						<button id="view-grid" class="btn btn-secondary btn-sm active" title="Vista Rejilla"><i
								class="fa-solid fa-grip"></i></button>
						<button id="view-list" class="btn btn-secondary btn-sm" title="Vista Lista"><i
								class="fa-solid fa-list"></i></button>
					</div>
				</div>

				<div class="gallery-grid" id="gallery" style="margin-top: 20px;">
					<!-- Gallery items will appear here -->
				</div>
			</div>

			<div class="card" style="margin-top: 24px; border-color: rgba(239, 68, 68, 0.3);">
				<div class="card-header">
					<span class="card-title" style="color: var(--danger)">Acciones Cr√≠ticas</span>
				</div>
				<p class="text-muted" style="margin-bottom: 16px;">Estas acciones no se pueden deshacer.</p>
				<div style="display: flex; gap: 12px;">
					<button id="btn-clear-gallery" class="btn btn-danger">
						<i class="fa-solid fa-trash-can"></i> Vaciar Galer√≠a
					</button>
					<button id="btn-reindex" class="btn btn-secondary">
						<i class="fa-solid fa-rotate"></i> Reindexar
					</button>
				</div>
			</div>
		</section>

		<!-- Trash Section -->
		<section id="section-trash" class="dashboard-section" style="display: none;">
			<div class="card" style="min-height: 400px;">
				<div class="card-header">
					<span class="card-title">Papelera de Reciclaje</span>
					<div class="header-actions" style="display: flex; gap: 12px; align-items: center;">
						<div
							style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 8px;">
							Auto-vaciado:
							<select id="trash-expiry" class="form-control"
								style="width: 80px; padding: 4px 25px 4px 10px; font-size: 11px; margin-bottom: 0;">
								<option value="7">7 d√≠as</option>
								<option value="15">15 d√≠as</option>
								<option value="30">30 d√≠as</option>
								<option value="0">Nunca</option>
							</select>
						</div>
						<button id="btn-empty-trash" class="btn btn-danger btn-sm">
							<i class="fa-solid fa-trash-arrow-up"></i> Vaciar Papelera
						</button>
					</div>
				</div>
				<p class="text-muted" style="margin-bottom: 24px; font-size: 14px;">Los elementos aqu√≠ se eliminar√°n
					autom√°ticamente despu√©s de 7 d√≠as. Puedes restaurarlos haciendo clic en el icono de recuperaci√≥n.
				</p>
				<div class="gallery-grid" id="trash-gallery">
					<!-- Trash items will appear here -->
				</div>
			</div>
		</section>

		<div id="batch-bar" class="batch-bar">
			<span id="batch-count" style="font-weight: 600; color: var(--accent);">0 seleccionados</span>
			<div style="display: flex; gap: 12px;">
				<button class="btn btn-secondary btn-sm" id="btn-batch-category"><i class="fa-solid fa-tags"></i>
					Categor√≠a</button>
				<button class="btn btn-secondary btn-sm" id="btn-batch-tags"><i class="fa-solid fa-hashtag"></i>
					Tags</button>
				<button class="btn btn-danger btn-sm" id="btn-batch-delete"><i class="fa-solid fa-trash"></i>
					Borrar</button>
				<button class="btn btn-secondary btn-sm" id="btn-batch-deselect">Cancelar</button>
			</div>
		</div>

	</main>

	<!-- Edit Modal -->
	<div id="edit-modal" class="modal-overlay">
		<div class="modal" style="max-width: 500px;">
			<div class="card-header" style="padding: 0 0 20px 0;">
				<span class="card-title">Editar Fotograf√≠a</span>
				<button id="edit-close" class="btn btn-secondary btn-sm"><i class="fa-solid fa-xmark"></i></button>
			</div>
			<input type="hidden" id="edit-id">
			<div class="form-group">
				<label>T√≠tulo</label>
				<input type="text" id="edit-title" class="form-control">
			</div>
			<div class="form-group">
				<label>Categor√≠a</label>
				<select id="edit-category" class="form-control">
					<option value="Bodas">Bodas</option>
					<option value="Retratos">Retratos</option>
					<option value="Familia">Familia</option>
					<option value="XV A√±os">XV A√±os</option>
				</select>
			</div>
			<div class="form-group">
				<label>Dise√±o (Layout)</label>
				<select id="edit-layout" class="form-control">
					<option value="normal">Normal</option>
					<option value="wide">Wide (Ancho)</option>
					<option value="tall">Tall (Alto)</option>
				</select>
			</div>
			<div class="form-group">
				<label>Etiquetas (separadas por coma)</label>
				<input type="text" id="edit-tags" class="form-control">
			</div>
			<div style="margin-top: 24px; display: flex; gap: 12px;">
				<button id="btn-save-edit" class="btn btn-primary btn-block">Guardar Cambios</button>
			</div>
		</div>
	</div>


	<!-- Lightbox / Preview Modal -->
	<div id="lightbox" class="modal-overlay">
		<div class="modal" style="max-width: 900px; padding: 0; overflow: hidden;">
			<button id="lb-close" class="btn btn-secondary"
				style="position: absolute; top: 16px; right: 16px; z-index: 10; padding: 8px;">
				<i class="fa-solid fa-xmark"></i>
			</button>
			<div style="display: flex; height: 500px;">
				<div style="flex: 1; background: #000; display: flex; align-items: center; justify-content: center;">
					<img id="lb-img" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
				</div>
				<div
					style="width: 300px; padding: 24px; background: var(--bg-sidebar); border-left: 1px solid var(--border-color);">
					<h3 id="lb-title" style="margin-bottom: 8px; font-family: 'Playfair Display', serif;"></h3>
					<p id="lb-cat" class="status-badge status-public"
						style="display: inline-block; margin-bottom: 16px;"></p>
					<div id="lb-details" class="text-secondary" style="font-size: 13px;"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Toast Container -->
	<div id="toast-container" class="toast-container"></div>

	<script>
		// --- DATA STATE ---
		let previewCounter = 0;
		const state = {
			totalPhotos: 0,
			categories: new Set(),
			isFirestoreOk: false,
			selectedItems: new Set(),
			recentActions: [],
			errors: [],
			viewMode: 'grid',
			photoTitles: new Set()
		};

		// --- DOM ELEMENTS ---
		const elements = {
			sidebar: document.getElementById('sidebar'),
			mobileToggle: document.getElementById('mobile-toggle'),
			navLinks: document.querySelectorAll('.nav-link[data-section]'),
			sections: document.querySelectorAll('.dashboard-section'),
			sectionTitle: document.getElementById('section-title'),
			sectionSubtitle: document.getElementById('section-subtitle'),
			dropArea: document.getElementById('drop-area'),
			fileInput: document.getElementById('file-input'),
			thumbs: document.getElementById('selected-thumbs'),
			previewList: document.getElementById('preview-list'),
			btnSaveAll: document.getElementById('btn-save-all'),
			btnClearAll: document.getElementById('btn-clear-all'),
			btnQuickUpload: document.getElementById('btn-quick-upload'),
			gallery: document.getElementById('gallery'),
			trashGallery: document.getElementById('trash-gallery'),
			toastContainer: document.getElementById('toast-container'),
			lightbox: document.getElementById('lightbox'),
			lbImg: document.getElementById('lb-img'),
			lbTitle: document.getElementById('lb-title'),
			lbCat: document.getElementById('lb-cat'),
			lbClose: document.getElementById('lb-close'),
			themeToggle: document.querySelector('.theme-toggle'),
			batchBar: document.getElementById('batch-bar'),
			batchCount: document.getElementById('batch-count'),
			btnBatchDeselect: document.getElementById('btn-batch-deselect'),
			btnBatchDelete: document.getElementById('btn-batch-delete'),
			btnBatchCategory: document.getElementById('btn-batch-category'),
			btnBatchTags: document.getElementById('btn-batch-tags'),
			historyList: document.getElementById('history-list'),
			errorLogList: document.getElementById('error-log-list'),
			viewGridBtn: document.getElementById('view-grid'),
			viewListBtn: document.getElementById('view-list')
		};

		// --- NAVIGATION LOGIC ---
		function showSection(sectionId) {
			elements.sections.forEach(s => s.style.display = 'none');
			const target = document.getElementById('section-' + sectionId);
			if (target) {
				target.style.display = 'block';
				elements.navLinks.forEach(l => l.classList.toggle('active', l.dataset.section === sectionId));

				// Update headers
				const titles = {
					overview: { t: 'Vista General', s: 'Resumen de tu actividad' },
					upload: { t: 'Subir Fotos', s: 'A√±ade nuevas obras a tu portafolio' },
					gallery: { t: 'Gestionar Galer√≠a', s: 'Organiza y edita tus fotos publicadas' },
					trash: { t: 'Papelera', s: 'Recupera o elimina permanentemente' }
				};
				elements.sectionTitle.textContent = titles[sectionId].t;
				elements.sectionSubtitle.textContent = titles[sectionId].s;

				// Hide batch bar if leaving gallery
				if (sectionId !== 'gallery') {
					elements.batchBar.classList.remove('active');
				} else if (state.selectedItems.size > 0) {
					elements.batchBar.classList.add('active');
				}
			}
			if (window.innerWidth < 900) elements.sidebar.classList.remove('open');
		}

		elements.navLinks.forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				showSection(link.dataset.section);
			});
		});

		elements.mobileToggle.addEventListener('click', () => {
			elements.sidebar.classList.toggle('open');
		});

		elements.btnQuickUpload.addEventListener('click', () => showSection('upload'));

		// --- UI HELPERS ---
		function showToast(message, type = 'success') {
			const toast = document.createElement('div');
			toast.className = 'toast';
			const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
			toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;
			elements.toastContainer.appendChild(toast);
			setTimeout(() => toast.classList.add('show'), 100);
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => toast.remove(), 300);
			}, 3000);
		}

		function logAction(action, detail) {
			const time = new Date().toLocaleTimeString();
			state.recentActions.unshift({ action, detail, time });
			if (state.recentActions.length > 20) state.recentActions.pop();
			localStorage.setItem('ensuenos_history', JSON.stringify(state.recentActions));
			updateHistoryUI();
		}

		function logError(message, detail) {
			const time = new Date().toLocaleTimeString();
			state.errors.unshift({ message, detail, time });
			if (state.errors.length > 20) state.errors.pop();
			localStorage.setItem('ensuenos_errors', JSON.stringify(state.errors));
			updateErrorLogUI();
		}

		function updateErrorLogUI() {
			if (!elements.errorLogList) return;
			if (state.errors.length === 0) {
				elements.errorLogList.innerHTML = '<p class="text-muted" style="font-size: 13px;">No hay errores recientes.</p>';
				return;
			}
			elements.errorLogList.innerHTML = state.errors.map(err => `
                <div class="error-item" style="border-left: 3px solid var(--danger);">
                    <i class="fa-solid fa-circle-xmark error-icon"></i>
                    <div style="flex:1;">
                        <strong>${err.message}</strong>
                        <div class="text-muted" style="font-size: 11px;">${err.detail}</div>
                    </div>
                    <div class="history-time">${err.time}</div>
                </div>
            `).join('');
		}

		function updateHistoryUI() {
			if (!elements.historyList) return;
			if (state.recentActions.length === 0) {
				elements.historyList.innerHTML = '<p class="text-muted" style="font-size: 13px;">No hay acciones recientes.</p>';
				return;
			}
			elements.historyList.innerHTML = state.recentActions.map(a => `
                <div class="history-item" style="border-left: 3px solid var(--accent);">
                    <div class="history-icon" style="width:24px; height:24px; font-size:12px;">
                        <i class="fa-solid ${getActionIcon(a.action)}"></i>
                    </div>
                    <div>
                        <strong style="font-size:12px;">${a.action}</strong>
                        <div class="text-muted" style="font-size: 10px;">${a.detail}</div>
                    </div>
                    <div class="history-time" style="font-size:10px;">${a.time}</div>
                </div>
            `).join('');
		}

		function getActionIcon(action) {
			if (action.includes('Subida')) return 'fa-cloud-arrow-up';
			if (action.includes('Edici√≥n')) return 'fa-pen-to-square';
			if (action.includes('Borrado')) return 'fa-trash-can';
			if (action.includes('Restaurado')) return 'fa-trash-arrow-up';
			return 'fa-bolt';
		}

		function listenTrash() {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();
			db.collection('papelera').orderBy('deletedAt', 'desc').onSnapshot(snap => {
				elements.trashGallery.innerHTML = '';
				if (snap.empty) {
					elements.trashGallery.innerHTML = '<p class="text-muted">La papelera est√° vac√≠a.</p>';
					return;
				}
				snap.forEach(doc => {
					const data = doc.data();

					// Auto-delete check
					const expiryDays = parseInt(document.getElementById('trash-expiry').value);
					if (expiryDays > 0 && data.deletedAt) {
						const deleteTime = data.deletedAt.toDate();
						const now = new Date();
						const diffDays = (now - deleteTime) / (1000 * 60 * 60 * 24);
						if (diffDays > expiryDays) {
							deletePermanently(doc.id, true); // True to avoid confirm
							return;
						}
					}

					const item = document.createElement('div');
					item.className = 'gallery-item trash-item';
					item.innerHTML = `
                        <img src="${data.url}">
                        <div class="overlay">
                            <span class="item-title">${data.title}</span>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <button class="btn btn-primary btn-sm restore-btn" title="Restaurar"><i class="fa-solid fa-rotate-left"></i></button>
                                <button class="btn btn-danger btn-sm delete-perm-btn" title="Borrar para siempre"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    `;
					item.onclick = (e) => {
						if (e.target.closest('.btn')) return;
						openLightbox(data);
					};
					item.querySelector('.restore-btn').onclick = (e) => { e.stopPropagation(); restoreItem(doc.id, data); };
					item.querySelector('.delete-perm-btn').onclick = (e) => { e.stopPropagation(); deletePermanently(doc.id); };
					elements.trashGallery.appendChild(item);
				});
			});
		}

		async function restoreItem(id, data) {
			const db = firebase.firestore();
			showToast('Restaurando...', 'warning');
			try {
				const { deletedAt, ...originalData } = data;
				await db.collection('imagenes').add(originalData);
				await db.collection('papelera').doc(id).delete();
				logAction('Restaurado', data.title);
				showToast('Imagen restaurada');
			} catch (err) {
				showToast('Error al restaurar', 'error');
			}
		}

		async function deletePermanently(id, silent = false) {
			if (!silent && !confirm('¬øEliminar permanentemente? Esta acci√≥n es irreversible.')) return;
			const db = firebase.firestore();
			try {
				await db.collection('papelera').doc(id).delete();
				if (!silent) {
					showToast('Eliminado definitivamente');
					logAction('Borrado Permanente', 'Limpieza de papelera');
				}
			} catch (err) {
				if (!silent) showToast('Error al eliminar', 'error');
			}
		}

		// --- BATCH LOGIC ---
		function toggleSelect(id, element) {
			if (state.selectedItems.has(id)) {
				state.selectedItems.delete(id);
				element.classList.remove('selected');
			} else {
				state.selectedItems.add(id);
				element.classList.add('selected');
			}
			updateBatchUI();
		}

		function updateBatchUI() {
			const count = state.selectedItems.size;
			elements.batchCount.textContent = `${count} seleccionados`;

			const isGallery = document.querySelector('.nav-link.active')?.dataset.section === 'gallery';
			elements.batchBar.classList.toggle('active', count > 0 && isGallery);
		}

		elements.btnBatchDeselect.onclick = () => {
			state.selectedItems.clear();
			document.querySelectorAll('.gallery-item.selected').forEach(el => el.classList.remove('selected'));
			updateBatchUI();
		};

		elements.btnBatchCategory.onclick = () => {
			const newCat = prompt("Nueva categor√≠a para los seleccionados:");
			if (!newCat) return;
			// Logic for bulk update would go here
			showToast("Funci√≥n de cambio masivo pr√≥ximamente", "warning");
		};

		elements.btnBatchTags.onclick = () => {
			const newTags = prompt("Nuevas etiquetas (separadas por coma):");
			if (!newTags) return;
			showToast("Funci√≥n de etiquetas masivas pr√≥ximamente", "warning");
		};

		elements.btnBatchDelete.onclick = async () => {
			if (!confirm(`¬øMover ${state.selectedItems.size} fotos a la papelera?`)) return;
			const db = firebase.firestore();
			showToast('Moviendo a papelera...', 'warning');
			try {
				const batch = db.batch();
				for (const id of state.selectedItems) {
					const doc = await db.collection('imagenes').doc(id).get();
					if (doc.exists) {
						batch.set(db.collection('papelera').doc(id), {
							...doc.data(),
							deletedAt: firebase.firestore.FieldValue.serverTimestamp()
						});
						batch.delete(doc.ref);
					}
				}
				await batch.commit();
				logAction('Borrado Lote', `${state.selectedItems.size} im√°genes`);
				state.selectedItems.clear();
				updateBatchUI();
				showToast('Movidos a papelera');
			} catch (err) {
				console.error('Batch Error:', err);
				if (err.code === 'permission-denied') {
					showToast('Error de Permisos: Revisa tus Firestore Rules.', 'error');
					logError('Error de Permisos', 'Revisa tus Firestore Rules para operaciones en lote.');
				} else {
					showToast('Error en el proceso de lote', 'error');
					logError('Error en Lote', err.message);
				}
			}
		};

		// --- UPLOAD LOGIC ---
		function prevent(e) { e.preventDefault(); e.stopPropagation(); }
		['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => elements.dropArea.addEventListener(evt, prevent));

		elements.dropArea.addEventListener('dragover', () => elements.dropArea.classList.add('dragover'));
		elements.dropArea.addEventListener('dragleave', () => elements.dropArea.classList.remove('dragover'));
		elements.dropArea.addEventListener('drop', (e) => {
			elements.dropArea.classList.remove('dragover');
			const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
			handleFiles(files);
		});

		elements.dropArea.addEventListener('click', () => elements.fileInput.click());
		elements.fileInput.addEventListener('change', () => handleFiles(Array.from(elements.fileInput.files)));

		function handleFiles(files) {
			if (files.length > 0) elements.thumbs.style.display = 'grid';
			files.forEach(file => {
				const isDuplicate = state.photoTitles.has(file.name);
				const url = file.url || URL.createObjectURL(file);
				const id = 'pv-' + (previewCounter++);

				// Mini Thumb
				const thumb = document.createElement('div');
				thumb.className = 'thumb';
				thumb.dataset.id = id;
				thumb.style.cssText = 'width: 80px; height: 80px; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid var(--border-color);';
				thumb.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`;
				elements.thumbs.appendChild(thumb);

				const card = document.createElement('div');
				card.className = 'preview-item';
				card.id = id;
				card.innerHTML = `
                    <div class="preview-img-container">
                        <img src="${url}" class="preview-img">
                        ${isDuplicate ? '<div class="duplicate-badge">DUPLICADO</div>' : ''}
                    </div>
                    <div class="preview-details">
                        <div class="preview-top-row">
                            <input type="text" class="form-control title-input" value="${file.name || 'Obra sin t√≠tulo'}" placeholder="T√≠tulo de la obra">
                            <span class="file-info-pill">${file.size ? (file.size / 1024).toFixed(0) + ' KB' : 'Origen Externo'}</span>
                        </div>
                        <div class="preview-mid-row">
                            <div class="input-icon-wrapper">
                                <i class="fa-solid fa-folder"></i>
                                <select class="form-control category-select">
                                    <option value="Bodas">Bodas</option>
                                    <option value="Retratos">Retratos</option>
                                    <option value="Familia">Familia</option>
                                    <option value="XV A√±os">XV A√±os</option>
                                </select>
                            </div>
                            <div class="input-icon-wrapper">
                                <i class="fa-solid fa-tag"></i>
                                <input type="text" class="form-control tags-input" placeholder="Etiquetas (boda, noche...)">
                            </div>
                        </div>
                        <div class="preview-bottom-row">
                            <label>LAYOUT:</label>
                            <div class="premium-layout-chips">
                                <label class="layout-pill"><input type="radio" name="layout-${id}" value="normal" checked><span><i class="fa-solid fa-square"></i> Standard</span></label>
                                <label class="layout-pill"><input type="radio" name="layout-${id}" value="wide"><span><i class="fa-solid fa-arrows-left-right"></i> Wide</span></label>
                                <label class="layout-pill"><input type="radio" name="layout-${id}" value="tall"><span><i class="fa-solid fa-arrows-up-down"></i> Tall</span></label>
                            </div>
                        </div>
                        <div class="card-pixel-progress" id="progress-${id}"></div>
                    </div>
                    <div class="preview-actions-sidebar">
                        <div style="display:flex; gap:8px;">
                            <button class="btn-circle rotate-btn" title="Rotar 90¬∞"><i class="fa-solid fa-rotate"></i></button>
                            <button class="btn-circle btn-danger-alt remove-btn" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <button class="upload-pill-btn upload-single-btn">
                            <i class="fa-solid fa-paper-plane"></i>
                            PUBLICAR
                        </button>
                    </div>
                `;

				// Events
				card.querySelector('.remove-btn').onclick = () => {
					card.remove();
					thumb.remove();
					updateUIState();
				};

				card.querySelector('.rotate-btn').onclick = () => rotatePreview(id, 90);
				card.querySelector('.upload-single-btn').onclick = () => saveItem(card, file);
				elements.previewList.appendChild(card);
			});
			updateUIState();
		}

		function updateUIState() {
			const count = elements.previewList.children.length;
			document.getElementById('pending-counter').textContent = `${count} Pendientes`;
			elements.btnSaveAll.disabled = count === 0;
		}

		async function saveItem(card, file) {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;

			const progressBar = card.querySelector('.card-pixel-progress');
			if (progressBar) progressBar.style.width = '20%';

			try {
				// Mock upload / To Data URL as in original code
				const reader = new FileReader();
				const dataUrl = await new Promise(res => {
					reader.onload = e => res(e.target.result);
					reader.readAsDataURL(file);
				});
				progressBar.style.width = '40%';

				const title = card.querySelector('.title-input').value || 'Sin t√≠tulo';
				const category = card.querySelector('.category-select').value;
				const tags = card.querySelector('.tags-input').value.split(',').map(t => t.trim()).filter(Boolean);
				const layout = card.querySelector('input[type="radio"]:checked').value;
				const rotation = parseInt(card.dataset.rotation || '0');

				const db = firebase.firestore();
				await db.collection('imagenes').add({
					url: dataUrl,
					title,
					category,
					tags,
					layout,
					rotation,
					order: 9999,
					createdAt: firebase.firestore.FieldValue.serverTimestamp()
				});

				progressBar.style.width = '100%';
				showToast(`"${title}" guardado con √©xito`);
				logAction('Subida Finalizada', `"${title}" en ${category}`);
				setTimeout(() => {
					const thumb = elements.thumbs.querySelector(`[data-id="${card.id}"]`);
					if (thumb) thumb.remove();
					card.remove();
					updateUIState();
				}, 500);

			} catch (err) {
				console.error(err);
				showToast('Error al guardar', 'error');
				logError('Error al guardar imagen', err.message);
				progressContainer.style.display = 'none';
			}
		}

		elements.btnSaveAll.onclick = async () => {
			const cards = Array.from(elements.previewList.children);
			for (const card of cards) {
				const btn = card.querySelector('.upload-single-btn');
				if (btn) btn.click();
				await new Promise(r => setTimeout(r, 200));
			}
		};

		elements.btnClearAll.onclick = () => {
			elements.previewList.innerHTML = '';
			elements.thumbs.innerHTML = '';
			updateUIState();
		};

		// --- GALLERY LOGIC ---
		let draggedItem = null;

		function listenGallery() {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();
			db.collection('imagenes').orderBy('order', 'asc').onSnapshot(snap => {
				elements.gallery.innerHTML = '';
				state.totalPhotos = snap.size;
				state.categories.clear();
				state.photoTitles.clear(); // Clear existing titles for fresh sync

				snap.forEach(doc => {
					const data = doc.data();
					state.categories.add(data.category);

					const item = document.createElement('div');
					item.className = 'gallery-item';
					if (data.layout && data.layout !== 'normal' && state.viewMode !== 'list') item.classList.add(data.layout);
					item.draggable = true;
					item.dataset.id = doc.id;
					item.dataset.category = data.category;
					item.dataset.title = data.title.toLowerCase();

					item.innerHTML = `
                        <img src="${data.url}" alt="${data.title}" style="transform: rotate(${data.rotation || 0}deg)">
                        <div class="overlay">
                            <span class="item-title">${data.title}</span>
                            <span class="item-meta">${data.category}</span>
                             <div style="margin-top: 8px; display: flex; gap: 4px;">
                                <button class="btn btn-secondary btn-sm link-btn" title="Obtener Enlace" style="padding: 4px 8px; font-size: 10px;">
                                    <i class="fa-solid fa-link"></i>
                                </button>
                                <button class="btn btn-secondary btn-sm edit-btn" title="Editar" style="padding: 4px 8px; font-size: 10px;">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-btn" title="Eliminar" style="padding: 4px 8px; font-size: 10px;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;

					// Drag and drop events (already implemented)
					item.addEventListener('dragstart', () => { draggedItem = item; item.style.opacity = '0.5'; });
					item.addEventListener('dragend', () => { draggedItem = null; item.style.opacity = '1'; });
					item.addEventListener('dragover', (e) => e.preventDefault());
					item.addEventListener('drop', (e) => {
						e.preventDefault();
						if (draggedItem && draggedItem !== item) {
							const allItems = Array.from(elements.gallery.children);
							const draggedIdx = allItems.indexOf(draggedItem);
							const targetIdx = allItems.indexOf(item);
							if (draggedIdx < targetIdx) elements.gallery.insertBefore(draggedItem, item.nextSibling);
							else elements.gallery.insertBefore(draggedItem, item);
						}
					});

					item.onclick = (e) => {
						if (e.target.closest('.btn')) return;
						toggleSelect(doc.id, item);
					};

					item.querySelector('.link-btn').onclick = (e) => {
						e.stopPropagation();
						navigator.clipboard.writeText(data.url);
						showToast('Enlace copiado');
					};

					item.querySelector('.edit-btn').onclick = (e) => {
						e.stopPropagation();
						openEditModal(doc.id, data);
					};

					item.querySelector('.delete-btn').onclick = async (e) => {
						e.stopPropagation();
						if (confirm('¬øMover esta foto a la papelera?')) {
							const db = firebase.firestore();
							try {
								showToast('Moviendo...', 'warning');
								await db.collection('papelera').doc(doc.id).set({
									...data,
									deletedAt: firebase.firestore.FieldValue.serverTimestamp()
								});
								await db.collection('imagenes').doc(doc.id).delete();
								showToast('Foto movida a papelera');
								logAction('Borrado', data.title);
							} catch (err) {
								console.error('Firebase Error:', err);
								if (err.code === 'permission-denied') {
									showToast('Error: No tienes permisos en Firebase para borrar. Revisa tus Rules.', 'error');
									logError('Error de Permisos', 'Revisa tus Firestore Rules para borrar im√°genes.');
								} else {
									showToast('Error al mover a papelera', 'error');
									logError('Error al mover a papelera', err.message);
								}
							}
						}
					};

					elements.gallery.appendChild(item);
					state.photoTitles.add(data.title);
				});

				updateStats();
				updateFilters();
			});
		}

		function updateFilters() {
			const select = document.getElementById('filter-category');
			const current = select.value;
			select.innerHTML = '<option value="all">Todas las categor√≠as</option>';
			state.categories.forEach(cat => {
				const opt = document.createElement('option');
				opt.value = cat;
				opt.textContent = cat;
				if (cat === current) opt.selected = true;
				select.appendChild(opt);
			});
		}

		// Search and Filter logic
		document.getElementById('gallery-search').addEventListener('input', applyGalleryFilters);
		document.getElementById('filter-category').addEventListener('change', applyGalleryFilters);

		function applyGalleryFilters() {
			const query = document.getElementById('gallery-search').value.toLowerCase();
			const category = document.getElementById('filter-category').value;
			const items = elements.gallery.querySelectorAll('.gallery-item');

			items.forEach(item => {
				const matchesSearch = item.dataset.title.includes(query);
				const matchesCategory = category === 'all' || item.dataset.category === category;
				item.style.display = (matchesSearch && matchesCategory) ? 'block' : 'none';
			});
		}

		document.getElementById('btn-save-order').onclick = async () => {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();
			const items = Array.from(elements.gallery.children);

			showToast('Guardando orden...', 'warning');
			const batch = db.batch();

			items.forEach((item, index) => {
				const docId = item.dataset.id;
				const docRef = db.collection('imagenes').doc(docId);
				batch.update(docRef, { order: index });
			});

			try {
				await batch.commit();
				showToast('Orden guardado correctamente');
			} catch (err) {
				console.error(err);
				showToast('Error al guardar el orden', 'error');
				logError('Error al guardar orden', err.message);
			}
		};

		function updateStats() {
			document.getElementById('stat-total-photos').textContent = state.totalPhotos;
			document.getElementById('stat-categories').textContent = state.categories.size;

			const categoriesList = Array.from(state.categories).join(', ');
			document.getElementById('stat-categories-list').textContent = categoriesList || 'Sin categor√≠as';
			document.getElementById('stat-public-count').textContent = `${state.totalPhotos} P√∫blicas`;

			// Calculate Top Category
			const counts = {};
			let topCat = '--';
			let maxCount = 0;
			elements.gallery.querySelectorAll('.gallery-item').forEach(item => {
				const cat = item.dataset.category;
				counts[cat] = (counts[cat] || 0) + 1;
				if (counts[cat] > maxCount) {
					maxCount = counts[cat];
					topCat = cat;
				}
			});
			document.getElementById('stat-top-cat').textContent = topCat;

			// Simular latencia de DB
			document.getElementById('db-latency').textContent = Math.floor(Math.random() * 50) + 20;

			// Usage Simulation
			const usagePercent = Math.min(95, (state.totalPhotos / 1000) * 100);
			document.getElementById('firestore-bar').style.width = usagePercent + '%';
			document.getElementById('firestore-usage').textContent = state.totalPhotos;

			// Fetch Last Upload
			if (typeof firebase !== 'undefined' && firebase.firestore) {
				const db = firebase.firestore();
				db.collection('imagenes').orderBy('createdAt', 'desc').limit(1).get().then(snap => {
					if (!snap.empty) {
						const data = snap.docs[0].data();
						const date = data.createdAt ? data.createdAt.toDate().toLocaleDateString() : '--';
						document.getElementById('stat-last-upload').textContent = date;
					}
				});
			}
		}

		// View Mode Toggle
		elements.viewGridBtn.onclick = () => {
			state.viewMode = 'grid';
			elements.gallery.classList.remove('list-view');
			elements.trashGallery.classList.remove('list-view');
			elements.viewGridBtn.classList.add('active');
			elements.viewListBtn.classList.remove('active');
		};
		elements.viewListBtn.onclick = () => {
			state.viewMode = 'list';
			elements.gallery.classList.add('list-view');
			elements.trashGallery.classList.add('list-view');
			elements.viewListBtn.classList.add('active');
			elements.viewGridBtn.classList.remove('active');
		};

		function openLightbox(data) {
			elements.lbImg.src = data.url;
			elements.lbTitle.textContent = data.title;
			elements.lbCat.textContent = data.category;
			elements.lightbox.style.display = 'flex';
		}

		elements.lbClose.onclick = () => elements.lightbox.style.display = 'none';
		elements.lightbox.onclick = (e) => { if (e.target === elements.lightbox) elements.lbClose.click(); };

		// --- THEME TOGGLE ---
		elements.themeToggle.addEventListener('click', () => {
			document.body.classList.toggle('light-mode');
			const icon = elements.themeToggle.querySelector('i');
			icon.classList.toggle('fa-moon');
			icon.classList.toggle('fa-sun');
		});

		// --- PREVIEW ACTIONS ---
		function rotatePreview(id, delta) {
			const card = document.getElementById(id);
			const thumb = elements.thumbs.querySelector(`[data-id="${id}"]`);
			if (!card || !thumb) return;

			const imgP = card.querySelector('.preview-img');
			const imgT = thumb.querySelector('img');

			let rot = parseInt(card.dataset.rotation || '0');
			rot = (rot + delta) % 360;
			card.dataset.rotation = rot;

			[imgP, imgT].forEach(img => {
				if (img) img.style.transform = `rotate(${rot}deg)`;
			});
		}

		// --- DANGER BOX ---
		document.getElementById('btn-clear-gallery').onclick = async () => {
			if (!confirm('¬øEST√ÅS SEGURO? Esta acci√≥n eliminar√° TODAS las im√°genes de la galer√≠a p√∫blica. No se puede deshacer.')) return;

			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();

			showToast('Eliminando galer√≠a...', 'warning');
			try {
				const snap = await db.collection('imagenes').get();
				if (snap.empty) {
					showToast('La galer√≠a ya est√° vac√≠a');
					return;
				}
				const batch = db.batch();
				snap.forEach(doc => batch.delete(doc.ref));
				await batch.commit();
				showToast('Galer√≠a vaciada con √©xito');
			} catch (err) {
				console.error(err);
				showToast('Error al vaciar la galer√≠a', 'error');
			}
		};

		document.getElementById('btn-reindex').onclick = handleReindex;
		document.getElementById('btn-reindex-quick').onclick = handleReindex;

		async function handleReindex() {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();
			showToast('Reindexando galer√≠a...', 'warning');

			try {
				// If orderBy fails due to missing index or missing fields, fallback to simple get
				let snap;
				try {
					snap = await db.collection('imagenes').orderBy('order', 'asc').get();
					if (snap.empty) snap = await db.collection('imagenes').get();
				} catch (e) {
					snap = await db.collection('imagenes').get();
				}

				const batch = db.batch();
				const docs = [];
				snap.forEach(doc => docs.push({ ref: doc.ref, data: doc.data() }));

				// Sort locally by order then by createdAt
				docs.sort((a, b) => (a.data.order || 0) - (b.data.order || 0));

				docs.forEach((doc, idx) => {
					batch.update(doc.ref, { order: idx });
				});

				await batch.commit();
				showToast('Reindexaci√≥n completada');
			} catch (err) {
				console.error('Reindex error:', err);
				showToast('Error al reindexar', 'error');
			}
		};

		// --- EDIT MODAL LOGIC ---
		const editModal = document.getElementById('edit-modal');
		const editClose = document.getElementById('edit-close');
		const btnSaveEdit = document.getElementById('btn-save-edit');

		function openEditModal(id, data) {
			document.getElementById('edit-id').value = id;
			document.getElementById('edit-title').value = data.title;
			document.getElementById('edit-category').value = data.category;
			document.getElementById('edit-layout').value = data.layout || 'normal';
			document.getElementById('edit-tags').value = (data.tags || []).join(', ');
			editModal.style.display = 'flex';
		}

		editClose.onclick = () => editModal.style.display = 'none';
		editModal.onclick = (e) => { if (e.target === editModal) editClose.click(); };

		btnSaveEdit.onclick = async () => {
			const id = document.getElementById('edit-id').value;
			const title = document.getElementById('edit-title').value;
			const category = document.getElementById('edit-category').value;
			const layout = document.getElementById('edit-layout').value;
			const tags = document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(Boolean);

			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();

			showToast('Actualizando...', 'warning');
			try {
				await db.collection('imagenes').doc(id).update({
					title,
					category,
					layout,
					tags
				});
				showToast('Cambios guardados');
				logAction('Edici√≥n', title);
				editModal.style.display = 'none';
			} catch (err) {
				showToast('Error al actualizar', 'error');
			}
		};


		// --- UTILITIES ---
		document.getElementById('btn-backup').onclick = async () => {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();
			showToast('Generando backup...', 'warning');
			try {
				const snap = await db.collection('imagenes').get();
				const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
				const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `backup_ensuenos_${new Date().toISOString().slice(0, 10)}.json`;
				a.click();
				showToast('Backup descargado');
				logAction('Backup', 'Copia de seguridad local');
			} catch (err) {
				showToast('Error en backup', 'error');
			}
		};

		document.getElementById('btn-url-add').onclick = async () => {
			const urlInput = document.getElementById('url-upload');
			const url = urlInput.value.trim();
			if (!url) return;

			showToast('Cargando imagen externa...', 'warning');
			handleFiles([{ name: 'Obra Externa', type: 'image/url', url: url }]);
			urlInput.value = '';
		};

		document.getElementById('btn-optimize-all').onclick = async () => {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			showToast('Optimizando galer√≠a...', 'warning');
			try {
				// Real logic: Reindex + Cleanup
				const db = firebase.firestore();
				const snap = await db.collection('imagenes').get();
				const batch = db.batch();
				let count = 0;
				snap.forEach(doc => {
					const data = doc.data();
					let updated = false;
					const updateData = {};

					if (!data.tags) { updateData.tags = []; updated = true; }
					if (data.order === undefined) { updateData.order = 999; updated = true; }

					if (updated) {
						batch.update(doc.ref, updateData);
						count++;
					}
				});
				await batch.commit();
				showToast(`Galer√≠a optimizada. ${count} cambios.`);
				logAction('Optimizaci√≥n', `${count} metadatos corregidos`);
			} catch (err) {
				showToast('Error al optimizar', 'error');
				logError('Optimizaci√≥n fallida', err.message);
			}
		};

		document.getElementById('btn-empty-trash').onclick = async () => {
			if (!confirm('¬øVaciar papelera permanentemente?')) return;
			const db = firebase.firestore();
			const snap = await db.collection('papelera').get();
			const batch = db.batch();
			snap.forEach(doc => batch.delete(doc.ref));
			await batch.commit();
			showToast('Papelera vaciada');
			logAction('Vaciado Papelera', 'Limpieza completa');
		};

		// --- INIT ---
		state.recentActions = JSON.parse(localStorage.getItem('ensuenos_history') || '[]');
		state.errors = JSON.parse(localStorage.getItem('ensuenos_errors') || '[]');
		updateHistoryUI();
		updateErrorLogUI();

		listenGallery();
		listenTrash();
		showSection('overview');

	</script>

	<style>
		/* Extra styles for dashboard components */
		.dashboard-theme {
			--accent: #cda45e;
			background-color: var(--bg-main);
		}

		.thumbs-grid .thumb {
			aspect-ratio: 1;
		}

		.btn-sm {
			padding: 6px 12px;
			font-size: 12px;
		}

		.dashboard-section {
			animation: fadeIn 0.4s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		/* Sidebar footer */
		.sidebar-footer {
			margin-top: auto;
			border-top: 1px solid var(--border-color);
			padding-top: 16px;
		}

		.title-input {
			border: none;
			background: transparent;
			font-size: 16px;
			font-weight: 600;
			padding: 0;
			color: var(--text-primary);
			margin-bottom: 8px;
		}

		.title-input:focus {
			background: var(--bg-input);
		}
	</style>
</body>

</html>