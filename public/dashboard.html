<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Dashboard — Galería de Sueños</title>

	<!-- Fonts & Icons -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

	<!-- Firebase SDKs (compat) -->
	<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
	<script>
		window.FIREBASE_CONFIG = {
			apiKey: "AIzaSyBJKfRHcU9xkrPZg-lpYOBQWEzFTzCVSFc",
			authDomain: "fotografias-ensuenos-35972.firebaseapp.com",
			projectId: "fotografias-ensuenos-35972",
			messagingSenderId: "440755499521",
			appId: "1:440755499521:web:d9d41ed30ea0e1f3a44600",
			measurementId: "G-XLTZPGKZJB"
		};
		try {
			if (typeof firebase !== 'undefined' && window.FIREBASE_CONFIG) {
				if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(window.FIREBASE_CONFIG);
			}
		} catch (e) {
			console.warn('Firebase init failed', e);
		}
	</script>

	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="dashboard.css">
</head>

<body class="dashboard-theme">
	<!-- Sidebar -->
	<aside class="sidebar" id="sidebar">
		<a href="/" class="sidebar-logo">
			<i class="fa-solid fa-camera-retro"></i>
			<span>Ensueños</span>
		</a>

		<nav class="side-nav">
			<a href="#" class="nav-link active" data-section="overview">
				<i class="fa-solid fa-house"></i>
				<span>Vista General</span>
			</a>
			<a href="#" class="nav-link" data-section="upload" id="nav-upload">
				<i class="fa-solid fa-cloud-arrow-up"></i>
				<span>Subir Fotos</span>
			</a>
			<a href="#" class="nav-link" data-section="gallery">
				<i class="fa-solid fa-images"></i>
				<span>Gestionar Galería</span>
			</a>
			<a href="#" class="nav-link" data-section="settings">
				<i class="fa-solid fa-gear"></i>
				<span>Configuración</span>
			</a>
		</nav>

		<div class="sidebar-footer">
			<a href="/" class="nav-link">
				<i class="fa-solid fa-arrow-left"></i>
				<span>Ir al Sitio</span>
			</a>
		</div>
	</aside>

	<!-- Main Content -->
	<main class="main-content">
		<!-- Dashboard Header -->
		<header class="dashboard-header">
			<div class="header-title">
				<h1 id="section-title">Vista General</h1>
				<p id="section-subtitle">Gestiona tu portafolio fotográfico</p>
			</div>

			<div class="header-actions">
				<div class="theme-toggle" title="Cambiar Tema">
					<i class="fa-solid fa-moon"></i>
				</div>
				<button class="btn btn-primary" id="btn-quick-upload">
					<i class="fa-solid fa-plus"></i>
					<span>Nueva Foto</span>
				</button>
				<div class="mobile-toggle" id="mobile-toggle">
					<i class="fa-solid fa-bars"></i>
				</div>
			</div>
		</header>

		<!-- Stats Grid (Overview) -->
		<section id="section-overview" class="dashboard-section">
			<div class="dashboard-grid">
				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Total Fotos</span>
							<i class="fa-solid fa-image text-muted"></i>
						</div>
						<h2 id="stat-total-photos">0</h2>
						<p class="text-muted" style="font-size: 12px; margin-top: 8px;">En la galería pública</p>
					</div>
				</div>
				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Categorías</span>
							<i class="fa-solid fa-tags text-muted"></i>
						</div>
						<h2 id="stat-categories">0</h2>
						<p class="text-muted" style="font-size: 12px; margin-top: 8px;">Activas en el sitio</p>
					</div>
				</div>
				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Estado</span>
							<i class="fa-solid fa-circle-check text-muted" style="color: var(--success)"></i>
						</div>
						<h2>Online</h2>
						<p class="text-muted" style="font-size: 12px; margin-top: 8px;">Firestore Conectado</p>
					</div>
				</div>
			</div>
		</section>

		<!-- Upload Section -->
		<section id="section-upload" class="dashboard-section" style="display: none;">
			<div class="dashboard-grid">
				<div class="col-8">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Subir Imágenes</span>
							<span id="pending-counter" class="status-badge status-private">0 Pendientes</span>
						</div>

						<div id="drop-area" class="upload-dropzone" tabindex="0">
							<i class="fa-solid fa-cloud-arrow-up"></i>
							<h3>Arrastra tus fotos aquí</h3>
							<p>O haz clic para seleccionar archivos (JPG, PNG, WebP)</p>
							<input id="file-input" type="file" accept="image/*" multiple style="display:none">
						</div>

						<div id="selected-thumbs" class="thumbs-grid"
							style="display: none; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 12px; margin-top: 24px;">
							<!-- Thumbs will appear here -->
						</div>

						<div id="preview-list" class="preview-list" style="margin-top: 24px;">
							<!-- Previews with metadata will appear here -->
						</div>
					</div>
				</div>

				<div class="col-4">
					<div class="card">
						<div class="card-header">
							<span class="card-title">Ajustes por Defecto</span>
						</div>
						<div class="form-group">
							<label>Visibilidad General</label>
							<select id="default-visibility" class="form-control">
								<option value="public">Pública</option>
								<option value="private">Privada</option>
								<option value="hidden">Oculta</option>
							</select>
						</div>
						<div class="form-group">
							<label>Etiquetas Comunes</label>
							<input id="default-tags" class="form-control" placeholder="ej: boda, retrato, exterior">
						</div>
						<div class="form-group">
							<label>Acciones en Lote</label>
							<div style="display: flex; gap: 8px; flex-direction: column;">
								<button id="btn-save-all" class="btn btn-primary" disabled>
									<i class="fa-solid fa-floppy-disk"></i> Guardar Todo
								</button>
								<button id="btn-clear-all" class="btn btn-secondary">
									<i class="fa-solid fa-trash-can"></i> Limpiar Lista
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Gallery Section -->
		<section id="section-gallery" class="dashboard-section" style="display: none;">
			<div class="card">
				<div class="card-header">
					<span class="card-title">Galería Publicada</span>
					<div class="header-actions">
						<button id="btn-toggle-view" class="btn btn-secondary btn-sm">
							<i class="fa-solid fa-list"></i>
						</button>
						<button id="btn-save-order" class="btn btn-primary btn-sm">
							Guardar Orden
						</button>
					</div>
				</div>

				<div class="gallery-grid" id="gallery">
					<!-- Gallery items will appear here -->
				</div>
			</div>

			<div class="card" style="margin-top: 24px; border-color: rgba(239, 68, 68, 0.3);">
				<div class="card-header">
					<span class="card-title" style="color: var(--danger)">Zona de Peligro</span>
				</div>
				<p class="text-muted" style="margin-bottom: 16px;">Estas acciones son permanentes y afectan al sitio
					público.</p>
				<button id="btn-clear-gallery" class="btn btn-danger">
					<i class="fa-solid fa-triangle-exclamation"></i> Vaciar Galería Pública
				</button>
			</div>
		</section>
	</main>

	<!-- Lightbox / Preview Modal -->
	<div id="lightbox" class="modal-overlay">
		<div class="modal" style="max-width: 900px; padding: 0; overflow: hidden;">
			<button id="lb-close" class="btn btn-secondary"
				style="position: absolute; top: 16px; right: 16px; z-index: 10; padding: 8px;">
				<i class="fa-solid fa-xmark"></i>
			</button>
			<div style="display: flex; height: 500px;">
				<div style="flex: 1; background: #000; display: flex; align-items: center; justify-content: center;">
					<img id="lb-img" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
				</div>
				<div
					style="width: 300px; padding: 24px; background: var(--bg-sidebar); border-left: 1px solid var(--border-color);">
					<h3 id="lb-title" style="margin-bottom: 8px; font-family: 'Playfair Display', serif;"></h3>
					<p id="lb-cat" class="status-badge status-public"
						style="display: inline-block; margin-bottom: 16px;"></p>
					<div id="lb-details" class="text-secondary" style="font-size: 13px;"></div>
				</div>
			</div>
		</div>
	</div>

	<!-- Toast Container -->
	<div id="toast-container" class="toast-container"></div>

	<script>
		// --- DATA STATE ---
		let previewCounter = 0;
		const state = {
			totalPhotos: 0,
			categories: new Set(),
			isFirestoreOk: false
		};

		// --- DOM ELEMENTS ---
		const elements = {
			sidebar: document.getElementById('sidebar'),
			mobileToggle: document.getElementById('mobile-toggle'),
			navLinks: document.querySelectorAll('.nav-link[data-section]'),
			sections: document.querySelectorAll('.dashboard-section'),
			sectionTitle: document.getElementById('section-title'),
			sectionSubtitle: document.getElementById('section-subtitle'),
			dropArea: document.getElementById('drop-area'),
			fileInput: document.getElementById('file-input'),
			thumbs: document.getElementById('selected-thumbs'),
			previewList: document.getElementById('preview-list'),
			btnSaveAll: document.getElementById('btn-save-all'),
			btnClearAll: document.getElementById('btn-clear-all'),
			btnQuickUpload: document.getElementById('btn-quick-upload'),
			gallery: document.getElementById('gallery'),
			toastContainer: document.getElementById('toast-container'),
			lightbox: document.getElementById('lightbox'),
			lbImg: document.getElementById('lb-img'),
			lbTitle: document.getElementById('lb-title'),
			lbCat: document.getElementById('lb-cat'),
			lbClose: document.getElementById('lb-close'),
			themeToggle: document.querySelector('.theme-toggle')
		};

		// --- NAVIGATION LOGIC ---
		function showSection(sectionId) {
			elements.sections.forEach(s => s.style.display = 'none');
			const target = document.getElementById('section-' + sectionId);
			if (target) {
				target.style.display = 'block';
				elements.navLinks.forEach(l => l.classList.toggle('active', l.dataset.section === sectionId));

				// Update headers
				const titles = {
					overview: { t: 'Vista General', s: 'Resumen de tu actividad' },
					upload: { t: 'Subir Fotos', s: 'Añade nuevas obras a tu portafolio' },
					gallery: { t: 'Gestionar Galería', s: 'Organiza y edita tus fotos publicadas' },
					settings: { t: 'Configuración', s: 'Ajustes de tu cuenta y sitio' }
				};
				elements.sectionTitle.textContent = titles[sectionId].t;
				elements.sectionSubtitle.textContent = titles[sectionId].s;
			}
			if (window.innerWidth < 900) elements.sidebar.classList.remove('open');
		}

		elements.navLinks.forEach(link => {
			link.addEventListener('click', (e) => {
				e.preventDefault();
				showSection(link.dataset.section);
			});
		});

		elements.mobileToggle.addEventListener('click', () => {
			elements.sidebar.classList.toggle('open');
		});

		elements.btnQuickUpload.addEventListener('click', () => showSection('upload'));

		// --- UI HELPERS ---
		function showToast(message, type = 'success') {
			const toast = document.createElement('div');
			toast.className = 'toast';
			const icon = type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation';
			toast.innerHTML = `<i class="fa-solid ${icon}"></i> <span>${message}</span>`;
			elements.toastContainer.appendChild(toast);
			setTimeout(() => toast.classList.add('show'), 100);
			setTimeout(() => {
				toast.classList.remove('show');
				setTimeout(() => toast.remove(), 300);
			}, 3000);
		}

		// --- UPLOAD LOGIC ---
		function prevent(e) { e.preventDefault(); e.stopPropagation(); }
		['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => elements.dropArea.addEventListener(evt, prevent));

		elements.dropArea.addEventListener('dragover', () => elements.dropArea.classList.add('dragover'));
		elements.dropArea.addEventListener('dragleave', () => elements.dropArea.classList.remove('dragover'));
		elements.dropArea.addEventListener('drop', (e) => {
			elements.dropArea.classList.remove('dragover');
			const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
			handleFiles(files);
		});

		elements.dropArea.addEventListener('click', () => elements.fileInput.click());
		elements.fileInput.addEventListener('change', () => handleFiles(Array.from(elements.fileInput.files)));

		function handleFiles(files) {
			if (files.length > 0) elements.thumbs.style.display = 'grid';
			files.forEach(file => {
				const url = URL.createObjectURL(file);
				const id = 'pv-' + (previewCounter++);

				// Add mini thumb
				const thumb = document.createElement('div');
				thumb.className = 'thumb';
				thumb.dataset.id = id;
				thumb.style.cssText = 'width: 80px; height: 80px; border-radius: 8px; overflow: hidden; position: relative; border: 1px solid var(--border-color);';
				thumb.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`;
				elements.thumbs.appendChild(thumb);

				// Add card preview
				const card = document.createElement('div');
				card.className = 'preview-item';
				card.id = id;
				card.innerHTML = `
                    <img src="${url}" class="preview-img">
                    <div class="preview-info">
                        <div class="form-group">
                            <input type="text" class="form-control title-input" placeholder="Título de la obra">
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <select class="form-control category-select">
                                <option value="Bodas">Bodas</option>
                                <option value="Retratos">Retratos</option>
                                <option value="Familia">Familia</option>
                                <option value="XV Años">XV Años</option>
                            </select>
                            <input type="text" class="form-control tags-input" placeholder="Tags (separados por coma)">
                        </div>
                        <div class="progress-container" style="display:none; height:4px; background:var(--border-color); margin-top:12px; border-radius:4px; overflow:hidden;">
                            <div class="progress-bar" style="width:0%; height:100%; background:var(--accent); transition: width 0.3s;"></div>
                        </div>
                    </div>
                    <div class="preview-actions">
                        <button class="btn btn-secondary btn-sm rotate-btn" title="Rotar">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                        <button class="btn btn-danger btn-sm remove-btn" title="Eliminar">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                        <button class="btn btn-primary btn-sm upload-single-btn">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                    </div>
                `;

				// Events for card
				card.querySelector('.remove-btn').onclick = () => {
					card.remove();
					thumb.remove();
					updateUIState();
				};

				card.querySelector('.rotate-btn').onclick = () => rotatePreview(id, 90);

				card.querySelector('.upload-single-btn').onclick = () => saveItem(card, file);

				elements.previewList.appendChild(card);
			});
			updateUIState();
		}

		function updateUIState() {
			const count = elements.previewList.children.length;
			document.getElementById('pending-counter').textContent = `${count} Pendientes`;
			elements.btnSaveAll.disabled = count === 0;
		}

		async function saveItem(card, file) {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;

			const progressContainer = card.querySelector('.progress-container');
			const progressBar = card.querySelector('.progress-bar');
			progressContainer.style.display = 'block';
			progressBar.style.width = '10%';

			try {
				// Mock upload / To Data URL as in original code
				const reader = new FileReader();
				const dataUrl = await new Promise(res => {
					reader.onload = e => res(e.target.result);
					reader.readAsDataURL(file);
				});
				progressBar.style.width = '40%';

				const title = card.querySelector('.title-input').value || 'Sin título';
				const category = card.querySelector('.category-select').value;
				const tags = card.querySelector('.tags-input').value.split(',').map(t => t.trim()).filter(Boolean);

				const db = firebase.firestore();
				await db.collection('imagenes').add({
					url: dataUrl,
					title,
					category,
					tags,
					order: 9999,
					createdAt: firebase.firestore.FieldValue.serverTimestamp()
				});

				progressBar.style.width = '100%';
				showToast(`"${title}" guardado con éxito`);
				setTimeout(() => {
					const thumb = elements.thumbs.querySelector(`[data-id="${card.id}"]`);
					if (thumb) thumb.remove();
					card.remove();
					updateUIState();
				}, 500);

			} catch (err) {
				console.error(err);
				showToast('Error al guardar', 'error');
				progressContainer.style.display = 'none';
			}
		}

		elements.btnSaveAll.onclick = async () => {
			const cards = Array.from(elements.previewList.children);
			for (const card of cards) {
				const btn = card.querySelector('.upload-single-btn');
				if (btn) btn.click();
				await new Promise(r => setTimeout(r, 200));
			}
		};

		elements.btnClearAll.onclick = () => {
			elements.previewList.innerHTML = '';
			elements.thumbs.innerHTML = '';
			updateUIState();
		};

		// --- GALLERY LOGIC ---
		let draggedItem = null;

		function listenGallery() {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();
			db.collection('imagenes').orderBy('order', 'asc').onSnapshot(snap => {
				elements.gallery.innerHTML = '';
				state.totalPhotos = snap.size;
				state.categories.clear();

				snap.forEach(doc => {
					const data = doc.data();
					state.categories.add(data.category);

					const item = document.createElement('div');
					item.className = 'gallery-item';
					item.draggable = true;
					item.dataset.id = doc.id;
					item.innerHTML = `
                        <img src="${data.url}" alt="${data.title}">
                        <div class="overlay">
                            <span class="item-title">${data.title}</span>
                            <span class="item-meta">${data.category}</span>
                            <div style="margin-top: 8px; display: flex; gap: 4px;">
                                <button class="btn btn-secondary btn-sm edit-btn" style="padding: 4px 8px; font-size: 10px;">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button class="btn btn-danger btn-sm delete-btn" style="padding: 4px 8px; font-size: 10px;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;

					// Drag and drop events
					item.addEventListener('dragstart', () => {
						draggedItem = item;
						item.style.opacity = '0.5';
					});

					item.addEventListener('dragend', () => {
						draggedItem = null;
						item.style.opacity = '1';
					});

					item.addEventListener('dragover', (e) => {
						e.preventDefault();
					});

					item.addEventListener('drop', (e) => {
						e.preventDefault();
						if (draggedItem && draggedItem !== item) {
							const allItems = Array.from(elements.gallery.children);
							const draggedIdx = allItems.indexOf(draggedItem);
							const targetIdx = allItems.indexOf(item);

							if (draggedIdx < targetIdx) {
								elements.gallery.insertBefore(draggedItem, item.nextSibling);
							} else {
								elements.gallery.insertBefore(draggedItem, item);
							}
						}
					});

					item.onclick = (e) => {
						if (e.target.closest('.btn')) return;
						openLightbox(data);
					};

					item.querySelector('.delete-btn').onclick = async (e) => {
						e.stopPropagation();
						if (confirm('¿Eliminar esta foto permanentemente?')) {
							await db.collection('imagenes').doc(doc.id).delete();
							showToast('Foto eliminada');
						}
					};

					elements.gallery.appendChild(item);
				});

				updateStats();
			});
		}

		document.getElementById('btn-save-order').onclick = async () => {
			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();
			const items = Array.from(elements.gallery.children);

			showToast('Guardando orden...', 'warning');
			const batch = db.batch();

			items.forEach((item, index) => {
				const docId = item.dataset.id;
				const docRef = db.collection('imagenes').doc(docId);
				batch.update(docRef, { order: index });
			});

			try {
				await batch.commit();
				showToast('Orden guardado correctamente');
			} catch (err) {
				console.error(err);
				showToast('Error al guardar el orden', 'error');
			}
		};

		function updateStats() {
			document.getElementById('stat-total-photos').textContent = state.totalPhotos;
			document.getElementById('stat-categories').textContent = state.categories.size;
		}

		function openLightbox(data) {
			elements.lbImg.src = data.url;
			elements.lbTitle.textContent = data.title;
			elements.lbCat.textContent = data.category;
			elements.lightbox.style.display = 'flex';
		}

		elements.lbClose.onclick = () => elements.lightbox.style.display = 'none';
		elements.lightbox.onclick = (e) => { if (e.target === elements.lightbox) elements.lbClose.click(); };

		// --- THEME TOGGLE ---
		elements.themeToggle.addEventListener('click', () => {
			document.body.classList.toggle('light-mode');
			const icon = elements.themeToggle.querySelector('i');
			icon.classList.toggle('fa-moon');
			icon.classList.toggle('fa-sun');
		});

		// --- PREVIEW ACTIONS ---
		function rotatePreview(id, delta) {
			const card = document.getElementById(id);
			const thumb = elements.thumbs.querySelector(`[data-id="${id}"]`);
			if (!card || !thumb) return;

			const imgP = card.querySelector('.preview-img');
			const imgT = thumb.querySelector('img');

			let rot = parseInt(card.dataset.rotation || '0');
			rot = (rot + delta) % 360;
			card.dataset.rotation = rot;

			[imgP, imgT].forEach(img => {
				if (img) img.style.transform = `rotate(${rot}deg)`;
			});
		}

		// --- DANGER BOX ---
		document.getElementById('btn-clear-gallery').onclick = async () => {
			if (!confirm('¿ESTÁS SEGURO? Esta acción eliminará TODAS las imágenes de la galería pública. No se puede deshacer.')) return;

			if (typeof firebase === 'undefined' || !firebase.firestore) return;
			const db = firebase.firestore();

			showToast('Eliminando galería...', 'warning');
			try {
				const snap = await db.collection('imagenes').get();
				if (snap.empty) {
					showToast('La galería ya está vacía');
					return;
				}
				const batch = db.batch();
				snap.forEach(doc => batch.delete(doc.ref));
				await batch.commit();
				showToast('Galería vaciada con éxito');
			} catch (err) {
				console.error(err);
				showToast('Error al vaciar la galería', 'error');
			}
		};

		// --- INIT ---
		listenGallery();
		showSection('overview');

	</script>

	<style>
		/* Extra styles for dashboard components */
		.dashboard-theme {
			--accent: #cda45e;
			background-color: var(--bg-main);
		}

		.thumbs-grid .thumb {
			aspect-ratio: 1;
		}

		.btn-sm {
			padding: 6px 12px;
			font-size: 12px;
		}

		.dashboard-section {
			animation: fadeIn 0.4s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		/* Sidebar footer */
		.sidebar-footer {
			margin-top: auto;
			border-top: 1px solid var(--border-color);
			padding-top: 16px;
		}

		.title-input {
			border: none;
			background: transparent;
			font-size: 16px;
			font-weight: 600;
			padding: 0;
			color: var(--text-primary);
			margin-bottom: 8px;
		}

		.title-input:focus {
			background: var(--bg-input);
		}
	</style>
</body>

</html>